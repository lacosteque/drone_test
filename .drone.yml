kind: pipeline
type: docker
name: default


environment:
  SRC_DIR: "/nerd_builder/src"
  BIN_DIR: "/nerd_builder/src/usr/bin"
  LOKI_DIR: "/nerd_builder/src/usr/share/loki-driver"
  OUTPUT_DIR: "/nerd_builder/output"
  TEMP_DIR: "/nerd_builder/temp"
  PKG_PATH: "/nerd_builder/temp/pkg_path.txt"
  Z: ""


steps:

- name: make structure
  image: alpine:latest
  volumes:
  - name: builder
    path:  /nerd_builder/
  commands:
  - mkdir -p "$${BIN_DIR}" "$${LOKI_DIR}" "$${TEMP_DIR}" "$${OUTPUT_DIR}"
  
- name: micro install
  image: alpine:3.15
  volumes:
  - name: builder
    path:  /nerd_builder/
  commands:
  - apk add --update --no-cache curl bash
  - curl -s --show-error https://getmic.ro | bash
  - mv ./micro "$${BIN_DIR}/nerdmicro"
  depends_on:
  - make structure

- name: fetch loki docker driver 
  image: alpine:3.15
  environment:
    VERSION: 2.7.0
  volumes:
  - name: builder
    path: /nerd_builder/
  - name: docker-socket
    path: /var/run/docker.sock
  - name: docker-plugins
    path: /plugins/
  privileged: true
  commands:
  - apk add --update --no-cache docker jq
  - | 
    if docker plugin ls | grep "grafana/loki-docker-driver:$${VERSION}"; then
      echo "Plugin already exists"
    else
      docker plugin install "grafana/loki-docker-driver:$${VERSION}" --grant-all-permissions
    fi
    
  - | 
    LOKI_ID=$(docker plugin ls | grep "grafana/loki-docker-driver:$${VERSION}" | awk '{print $1}')
      if [ -n "$${LOKI_ID}" ]; then
        INSPECT_RESULT=$(docker plugin inspect --format '{{json .}}' "$${LOKI_ID}")
        LOKI_PLUGIN_ID=$(echo "$${INSPECT_RESULT}" | jq -r '.Id')

        cp -r "/plugins/$${LOKI_PLUGIN_ID}/rootfs" "$${TEMP_DIR}"
        rm -f "$${TEMP_DIR}/rootfs/var/run"
        cat "/plugins/$${LOKI_PLUGIN_ID}/config.json" | jq .plugin.Config > "$${TEMP_DIR}/config.json"
        tar -czf "/$${LOKI_DIR}/loki-docker-driver-$${VERSION}.tar.gz" \
            -C "$${TEMP_DIR}" rootfs config.json
      else
        echo "Loki Logging Driver not found."
      fi
  depends_on:
  - micro install

- name: build nerd
  image: alpine:3.15
  environment:
    GOOS: linux
    GOARCH: amd64
    CGO_ENABLED: 0
  volumes:
  - name: builder
    path: /nerd_builder/
  commands:
  - apk add --update --no-cache go
  - go build -o "$${BIN_DIR}/nerd" main.go
  depends_on:
  - fetch loki docker driver

- name: make pkg
  image: alpine:3.15
  environment:
    TZ: Europe/Moscow
    NAME: nerd-build
    ARCH: x86_64
    RELEASE: 1.1.1
    OUTPUT_TYPE: rpm
    INPUT_TYPE: dir
    LICENSE: GNU GPL
    LOG: error
  volumes:
  - name: builder
    path: /nerd_builder/
  commands:
  - apk add --no-cache ruby tzdata && gem install fpm
  - |
    if [ "$${OUTPUT_TYPE}" = "rpm" ]; then \
        apk add --no-cache rpm; \
    elif [ "$${OUTPUT_TYPE}" = "deb" ]; then \
        apk add --no-cache binutils tar; \
    fi
  - VERSION="$(TZ=$${TZ} date +'%Y%m%dT%H%M%S')-$${RELEASE}"
  - echo "$${VERSION}"
  - PACKAGE_PATH="$${OUTPUT_DIR}/$${NAME}-$${VERSION}.$${ARCH}.$${OUTPUT_TYPE}"
  - | 
    #Command-line Reference - https://fpm.readthedocs.io/en/latest/cli-reference.html
    fpm -s "$${INPUT_TYPE}" \
        -t "$${OUTPUT_TYPE}" \
        -p "$${PACKAGE_PATH}" \
        -n "$${NAME}" \
        -v "$${VERSION}" \
        -a "$${ARCH}" \
        --license "$${LICENSE}" \
        --log "$${LOG}" \
        --description "Ð¡Ñ€ÐµÐ´ÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Docker-ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ðŸ¤“" \
        --url "https://dev.gnivc.ru/gnivc/nerd/" \
        -C "$${SRC_DIR}" .
  - echo "$${PACKAGE_PATH}" > "$${PKG_PATH}"
  - export Z="$${PACKAGE_PATH}"
  depends_on:
  - build nerd

- name: push storage
  image: alpine:3.15
  environment:
    URL: http://10.250.26.8:9000
    PASS:
      from_secret: pass
  volumes:
  - name: builder
    path: /nerd_builder/
  commands:
  - echo "$${Z}" 
  - apk add --no-cache curl bash 
  - curl -Os https://76ea63ad-874c-4390-a572-052dccadefc6.selstorage.ru/supload/supload.sh
  - cp supload.sh /usr/local/bin/supload
  - chmod +x /usr/local/bin/supload
  - FILE=$(cat "$${PKG_PATH}")
  - supload -u 47066_temp -k "$${PASS}" temp "$${FILE}"
  depends_on:
  - make pkg

volumes:
- name: builder
  temp: {}

- name: docker-socket
  host:
    path: /var/run/docker.sock

- name: docker-plugins
  host:
    path: /var/lib/docker/plugins/
