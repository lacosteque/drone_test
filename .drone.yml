kind: pipeline
type: docker
name: default

environment:
  HOME_DIR: nerd_builder
  TEMP: temp

steps:

- name: make structure
  image: alpine:latest
  volumes:
  - name: builder_dir
    path: ~
  commands:
  - |
    mkdir -p "~/$${HOME_DIR}/src/usr/bin/" \
             "~/$${HOME_DIR}/src/usr/share/" \
             "~/$${HOME_DIR}/$${TEMP}" \
             "~/$${HOME_DIR}/output"

        
- name: micro install
  image: alpine:latest
  volumes:
  - name: temp
    path: /tmp
  commands:
  - apk add --update --no-cache micro
  - mv $(which micro) "/tmp/$${HOME_DIR}/src/usr/bin/nerdmicro"
  depends_on:
  - make structure

- name: prepared loki
  image: alpine:latest
  environment:
    VERSION: 2.7.0
  volumes:
  - name: temp
    path: /tmp
  - name: docker-socket
    path: /var/run/docker.sock
  - name: docker-plugins
    path: /var/lib/docker/plugins/
  privileged: true
  commands:
  - apk add --update --no-cache docker jq
  - | 
    if docker plugin ls | grep "grafana/loki-docker-driver:$${VERSION}"; then
      echo "Plugin already exists"
    else
      docker plugin install "grafana/loki-docker-driver:$${VERSION}" --grant-all-permissions
    fi
    
  - | 
    loki_id=$(docker plugin ls | awk '/Loki Logging Driver/ {print $1}')
      if [ -n "$loki_id" ]; then
        inspect_result=$(docker plugin inspect --format '{{json .}}' "$loki_id")
        loki_plugin_id=$(echo "$inspect_result" | jq -r '.Id')

        cp -r "/var/lib/docker/plugins/$${loki_plugin_id}/rootfs" "/tmp/$${HOME_DIR}/$${TEMP}/"
        rm -f "/tmp/$${HOME_DIR}/$${TEMP}/rootfs/var/run"
        cat "/var/lib/docker/plugins/$${loki_plugin_id}/config.json" | jq .plugin.Config > "/tmp/$${HOME_DIR}/$${TEMP}/config.json"
        tar -czf "/tmp/$${HOME_DIR}/src/usr/share/loki-docker-driver-$${VERSION}.tar.gz" \
            -C "/tmp/$${HOME_DIR}/$${TEMP}"\
            rootfs \
            config.json
      else
        echo "Loki Logging Driver not found."
      fi
  depends_on:
  - micro install

      
- name: build bin
  image: alpine:latest
  volumes:
  - name: temp
    path: /tmp
  commands:
  - apk add --update --no-cache go
  - mkdir -p "/tmp/$${HOME_DIR}/usr/bin"
  - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o "/tmp/$${HOME_DIR}/src/usr/bin/hello" main.go
  depends_on:
  - prepared loki


- name: make pkg
  image: alpine:latest
  environment:
    TZ: Europe/Moscow
    ARCH: x86_64
    RELEASE: 1.1.1
    NAME: nerd-build
    src: rpm
  volumes:
  - name: temp
    path: /tmp
  commands:
  - apk add --no-cache ruby tzdata && gem install fpm
  - |
    if [ "$src" = "rpm" ]; then \
        apk add --no-cache rpm; \
    elif [ "$src" = "deb" ]; then \
        apk add --no-cache binutils tar; \
    fi
  - export VERSION=$(TZ=$${TZ} date +'%Y%m%dT%H%M%S')
  - export PATH_FILE="/tmp/$${HOME_DIR}/output/$${NAME}-$${VERSION}-$${RELEASE}.$${ARCH}.$${src}"
  - | 
    fpm -s dir -t $${src} \
        -p "$${PATH_FILE}" \
        -n "$${NAME}" \
        -v "$${RELEASE}" \
        -a "$${ARCH}" \
        -C "/tmp/$${HOME_DIR}/src/" .
  - echo "$${PATH_FILE}" > "/tmp/$${HOME_DIR}/$${TEMP}/path.txt"
  depends_on:
  - build bin


- name: pull
  image: alpine:3.15
  environment:
    TG_TOKEN:
      from_secret: tg_token
    TO: -1001184051909
  volumes:
  - name: temp
    path: /tmp
  commands:
  - export PATH_FILE=$(cat "/tmp/$${HOME_DIR}/path.txt") 
  - apk add --update --no-cache curl
  - |
     curl -s "https://api.telegram.org/bot$${TG_TOKEN}/sendDocument" \
        -F chat_id="$${TO}" \
        -F parse_mode="HTML" \
        -F document=@$${PATH_FILE}
  depends_on:
  - make pkg
  

        
    
  

volumes:
- name: builder_dir
  host:
    path: /tmp

- name: configs
  temp: {}

- name: docker-socket
  host:
    path: /var/run/docker.sock

- name: docker-plugins
  host:
    path: /var/lib/docker/plugins/
